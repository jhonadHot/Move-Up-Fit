<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas - Sistema de Gest√£o</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .venda-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }
        .busca-produto {
            flex: 1;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .carrinho {
            flex: 1;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .produto-item {
            border: 1px solid #ddd;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .produto-item:hover {
            background-color: #f5f5f5;
        }
        .carrinho-item {
            border: 1px solid #ddd;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-venda {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: right;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #ff4500;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="../assets/images/Move Up.png" alt="Move Up Fit">
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <button class="menu-toggle" id="menuToggle">‚ò∞</button>
        <nav class="nav-menu">
            <ul>
                <li><a href="../index.html">In√≠cio</a></li>
                <li>
                    <a href="#" onclick="toggleSubmenu(event)">Cadastro</a>
                    <ul class="submenu">
                        <li><a href="cadastro-marca.html">Fornecedor</a></li>
                        <li><a href="cadastro-maquinas.html">M√°quina de Cart√£o</a></li>
                        <li><a href="cadastro-pix.html">PIX</a></li>
                        <li><a href="cadastro-pecas.html">Pe√ßas</a></li>
                    </ul>
                </li>
                <li><a href="estoque.html">Estoque</a></li>
                <li id="menuUsuarios" style="display: none;"><a href="gerenciar-usuarios.html">Gerenciar Usu√°rios</a></li>
                <li>
                    <a href="#" onclick="toggleSubmenu(event)">Relat√≥rios</a>
                    <ul class="submenu">
                        <li><a href="relatorio-financeiro.html">Financeiro</a></li>
                        <li><a href="relatorio-vendas.html">Vendas</a></li>
                        <li><a href="relatorio-analitico.html">Anal√≠tico</a></li>
                    </ul>
                </li>
                <li><a href="vendas.html">Vendas</a></li>
                <li><a href="#" onclick="logout()" style="color: #ff6b6b;">Sair</a></li>
            </ul>
        </nav>
    </div>

    <main class="main-content" style="margin-top: 200px;">
        <h1 style="text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #ff4500; font-weight: 300; font-size: 2.5rem; margin-bottom: 2rem;">Vendas</h1>
        
        <!-- Seletor de Tipo de Opera√ß√£o -->
        <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px;">
                <label style="margin-right: 2rem; font-size: 1.1rem; cursor: pointer;">
                    <input type="radio" name="tipoOperacao" value="venda" checked onchange="alterarTipoOperacao()" style="margin-right: 8px;"> Venda Normal
                </label>
                <label style="font-size: 1.1rem; cursor: pointer;">
                    <input type="radio" name="tipoOperacao" value="retirada" onchange="alterarTipoOperacao()" style="margin-right: 8px;"> Retirada Interna
                </label>
            </div>
        </div>
        
        <!-- Dados do Cliente/Usu√°rio - Bloco Separado -->
        <div class="cliente-container" id="clienteContainer" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2rem; max-width: 900px; margin-left: auto; margin-right: auto;">
            <h3 id="tituloCliente" style="color: #ff4500; border-bottom: 2px solid #ff4500; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Dados do Cliente</h3>
            
            <!-- Seletor de Usu√°rio para Retirada -->
            <div id="seletorUsuario" style="display: none;">
                <div class="form-group">
                    <label for="usuarioRetirada">Usu√°rio que fez a retirada: <span style="color: red;">*</span></label>
                    <select id="usuarioRetirada" required onchange="atualizarCarrinho()">
                        <option value="">Selecione o usu√°rio...</option>
                    </select>
                </div>
            </div>
            
            <!-- Dados do Cliente (Venda Normal) -->
            <div id="dadosCliente">
            <div class="form-row">
                <div class="form-group" style="position: relative;">
                    <label for="nomeCliente">Nome Completo: <span style="color: red;">*</span></label>
                    <input type="text" id="nomeCliente" placeholder="Nome completo do cliente" required autocomplete="off">
                    <div id="sugestoesClientes" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                    <small id="nomeError" style="color: red; display: none;">Nome deve ter pelo menos dois nomes</small>
                </div>
                <div class="form-group">
                    <label for="emailCliente">E-mail:</label>
                    <input type="email" id="emailCliente" placeholder="cliente@email.com">
                    <small id="emailError" style="color: red; display: none;">E-mail inv√°lido</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefoneCliente">Telefone: <span style="color: red;">*</span></label>
                    <input type="tel" id="telefoneCliente" placeholder="(00) 00000-0000" required>
                    <small id="telefoneError" style="color: red; display: none;">Telefone inv√°lido</small>
                </div>
                <div class="form-group">
                    <label for="cpfCliente">CPF: <span style="color: red;">*</span></label>
                    <input type="text" id="cpfCliente" placeholder="000.000.000-00" required>
                    <small id="cpfError" style="color: red; display: none;">CPF inv√°lido</small>
                </div>
            </div>
            </div>
        </div>
        
        <div class="venda-container" style="max-width: 1200px; margin: 0 auto;">
            <div class="busca-produto" style="border-radius: 15px;">
                <h3 style="color: #ff4500; border-bottom: 2px solid #ff4500; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Buscar Pe√ßa</h3>
                <div class="form-group">
                    <input type="text" id="buscaPeca" placeholder="Digite o nome da pe√ßa..." onkeyup="buscarPecas()">
                </div>
                
                <h3 style="margin-top: 2rem;">Selecionar</h3>
                <div class="form-group">
                    <select id="selectPeca" onchange="mostrarDetalhesPeca()">
                        <option value="">Selecione uma pe√ßa...</option>
                    </select>
                </div>
                <div id="detalhesPeca" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                    <div id="infoPeca"></div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="quantidade">Quantidade:</label>
                        <input type="number" id="quantidade" min="1" value="1" style="width: 80px;">
                        <button class="btn" onclick="adicionarAoCarrinho()" style="margin-left: 10px;">Adicionar ao Carrinho</button>
                    </div>
                </div>
            </div>

            <div class="carrinho" style="border-radius: 15px;">
                <h3 style="color: #ff4500; border-bottom: 2px solid #ff4500; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Carrinho</h3>
                <div id="itensCarrinho"></div>
                
                <div style="margin-top: 1rem; padding-top: 1rem;">
                    <!-- TEM ENTRADA - PRIMEIRO -->
                    <div class="form-group">
                        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                            <span>Tem Entrada?</span>
                            <input type="checkbox" id="temEntrada" onchange="mostrarOpcoesEntrada()"> 
                        </label>
                    </div>
                    
                    <div id="opcoesEntrada" style="display: none; border: 2px solid #ff4500; background-color: #fff3e6; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-top: 0; color: #ff4500;">Entrada</h4>
                        
                        <div class="form-group">
                            <label for="valorEntrada">Valor da Entrada (R$):</label>
                            <input type="number" id="valorEntrada" step="0.01" min="0" placeholder="0,00" onchange="calcularTotal()" style="width: 120px;">
                        </div>
                        
                        <div class="form-group">
                            <label for="formaPagamentoEntrada">Forma de Pagamento da Entrada:</label>
                            <select id="formaPagamentoEntrada" onchange="mostrarOpcoesEntrada()">
                                <option value="">Selecione...</option>
                                <option value="debito">Cart√£o de D√©bito</option>
                                <option value="avista">√Ä Vista</option>
                            </select>
                        </div>
                        
                        <!-- Op√ß√µes D√©bito Entrada -->
                        <div id="opcoesDebitoEntrada" style="display: none;">
                            <div class="form-group">
                                <label for="maquinaCartaoEntrada">M√°quina de Cart√£o:</label>
                                <select id="maquinaCartaoEntrada" onchange="mostrarBandeirasEntrada()">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div id="opcoesBandeiraEntrada" style="display: none;">
                                <div class="form-group">
                                    <label for="bandeiraCartaoEntrada">Bandeira:</label>
                                    <select id="bandeiraCartaoEntrada" onchange="calcularTotal()">
                                        <option value="">Selecione...</option>
                                        <option value="visa">Visa</option>
                                        <option value="mastercard">Mastercard</option>
                                        <option value="elo">Elo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Op√ß√µes √Ä Vista Entrada -->
                        <div id="opcoesAvistaEntrada" style="display: none;">
                            <div class="form-group">
                                <label for="tipoAvistaEntrada">Tipo:</label>
                                <select id="tipoAvistaEntrada" onchange="mostrarOpcoesPixEntrada()">
                                    <option value="">Selecione...</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="pix">PIX</option>
                                </select>
                            </div>
                            
                            <div id="opcoesPixEntrada" style="display: none;">
                                <div class="form-group">
                                    <label>Chave PIX:</label>
                                    <p style="font-size: 0.9rem; color: #007bff; font-weight: bold; font-family: monospace;" id="chavePixEntrada">Carregando...</p>
                                    <button type="button" class="btn btn-secondary" onclick="copiarChavePixEntrada()" style="padding: 0.5rem;">üìã Copiar Chave</button>
                                </div>
                                <div id="qrCodeContainerEntrada" style="display: none; text-align: center; margin-top: 1rem;">
                                    <div id="qrcodeEntrada"></div>
                                    <p style="font-size: 0.8rem; margin-top: 0.5rem;">Valor: R$ <span id="valorPixEntrada">0,00</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FORMA DE PAGAMENTO - SEGUNDO -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="formaPagamento">Forma de Pagamento:</label>
                        <select id="formaPagamento" onchange="mostrarOpcoesPagamento()">
                            <option value="">Selecione...</option>
                            <option value="credito">Cart√£o de Cr√©dito</option>
                            <option value="debito">Cart√£o de D√©bito</option>
                            <option value="avista">√Ä Vista</option>
                            <option value="crediario">Credi√°rio</option>
                        </select>
                    </div>
                    
                    <!-- Op√ß√µes Cart√£o -->
                    <div id="opcoesCreditoDebito" style="display: none;">
                        <div class="form-group">
                            <label for="maquinaCartao">M√°quina de Cart√£o:</label>
                            <select id="maquinaCartao" onchange="mostrarBandeiras()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div id="opcoesBandeira" style="display: none;">
                            <div class="form-group">
                                <label for="bandeiraCartao">Bandeira:</label>
                                <select id="bandeiraCartao" onchange="mostrarParcelamento()">
                                    <option value="">Selecione...</option>
                                    <option value="visa">Visa</option>
                                    <option value="mastercard">Mastercard</option>
                                    <option value="elo">Elo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Op√ß√µes Cart√£o Cr√©dito -->
                    <div id="opcoesCredito" style="display: none;">
                        <div class="form-group">
                            <label for="parcelas">Parcelas:</label>
                            <select id="parcelas" onchange="calcularTotal()">
                                <option value="1">1x</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Op√ß√µes √Ä Vista -->
                    <div id="opcoesAvista" style="display: none;">
                        <div class="form-group">
                            <label for="tipoAvista">Tipo:</label>
                            <select id="tipoAvista" onchange="mostrarOpcoesPix()">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">PIX</option>
                            </select>
                        </div>
                        
                        <div id="opcoesPix" style="display: none;">
                            <div class="form-group">
                                <label>Chave PIX:</label>
                                <p style="font-size: 0.9rem; color: #007bff; font-weight: bold; font-family: monospace;" id="chavePix">Carregando...</p>
                                <button type="button" class="btn btn-secondary" onclick="copiarChavePix()" style="padding: 0.5rem;">üìã Copiar Chave</button>
                            </div>
                            <div id="qrCodeContainer" style="display: none; text-align: center; margin-top: 1rem;">
                                <div id="qrcode"></div>
                                <p style="font-size: 0.8rem; margin-top: 0.5rem;">Valor: R$ <span id="valorPix">0,00</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Op√ß√µes Credi√°rio -->
                    <div id="opcoesCrediario" style="display: none;">
                        <div class="form-group">
                            <label for="parcelasCrediario">Parcelas:</label>
                            <select id="parcelasCrediario" onchange="calcularTotal()">
                                <option value="1">1x</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- DESCONTO E DATA - TERCEIRO -->
                    <div style="display: flex; gap: 1rem; align-items: end;">
                        <div class="form-group" id="descontoGroup" style="display: none;">
                            <label for="desconto">Desconto (R$):</label>
                            <input type="number" id="desconto" step="0.01" min="0" value="0" onchange="calcularTotal()" style="width: 100px;">
                        </div>
                        <div class="form-group" id="dataPromessaGroup" style="display: none;">
                            <label for="dataPromessa">Data 1¬™ Parcela:</label>
                            <input type="date" id="dataPromessa" onchange="calcularTotal()" style="width: 140px;">
                        </div>
                    </div>
                    
                    <div id="infoTaxa" style="display: none; font-size: 0.9rem; color: #666; margin-top: 0.5rem;"></div>
                </div>
                
                <div class="total-venda">
                    <div id="subtotal">Subtotal: R$ 0,00</div>
                    <div id="valorDesconto" style="color: #28a745;">Desconto: R$ 0,00</div>
                    <div id="valorEntradaDisplay" style="display: none;">Entrada: R$ 0,00</div>
                    <div id="totalVenda" style="font-size: 1.3rem; margin-top: 0.5rem; color: #dc3545;">Total: R$ 0,00</div>
                    <div id="saldoRestante" style="display: none; font-size: 1.1rem; color: #ff4500;">Saldo Restante: R$ 0,00</div>
                    <div id="parcelamentoInfo" style="display: none; font-size: 1rem; color: #007bff; margin-top: 0.5rem;"></div>
                    <div id="cronogramaPagamentos" style="display: none; font-size: 0.9rem; color: #666; margin-top: 0.5rem; border-top: 1px solid #ddd; padding-top: 0.5rem;"></div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="finalizarOperacao()" id="btnFinalizar" disabled>Finalizar Venda</button>
                    <button class="btn btn-secondary" onclick="limparCarrinho()">Limpar Carrinho</button>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/script.js"></script>
    <script src="../js/firebase-config.js?v=6"></script>
    <script>
        let produtosDisponiveis = [];
        let carrinho = [];
        let pecaSelecionada = null;
        let tipoOperacao = 'venda';
        let usuariosDisponiveis = [];
        let maquinasDisponiveis = [];
        let pixPrincipal = null;

        // Verificar autentica√ß√£o
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = '../login.html';
            } else {
                const nivel = await FirebaseDatabase.obterNivelUsuario(user.uid);
                if (nivel === 'master') {
                    document.getElementById('menuUsuarios').style.display = 'block';
                }
                carregarProdutos();
                carregarUsuarios();
                carregarMaquinas();
                await carregarPixPrincipal();
                
                // Verificar se √© edi√ß√£o de venda
                const urlParams = new URLSearchParams(window.location.search);
                const editarVendaId = urlParams.get('editar');
                if (editarVendaId) {
                    carregarVendaParaEdicao(editarVendaId);
                }
            }
        });

        // Fun√ß√£o de logout
        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = '../login.html';
            });
        }

        async function carregarProdutos() {
            try {
                produtosDisponiveis = await FirebaseDatabase.obterPecas();
                // Filtrar apenas produtos com estoque
                produtosDisponiveis = produtosDisponiveis.filter(produto => produto.estoque > 0);
                
                // Preencher select de pe√ßas
                const select = document.getElementById('selectPeca');
                select.innerHTML = '<option value="">Selecione uma pe√ßa...</option>';
                
                produtosDisponiveis.forEach(produto => {
                    const option = document.createElement('option');
                    option.value = produto.id;
                    option.text = `${produto.nome} - ${produto.marca} (${produto.codigo})`;
                    select.add(option);
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }
        
        async function carregarUsuarios() {
            try {
                usuariosDisponiveis = await FirebaseDatabase.obterUsuarios();
                const select = document.getElementById('usuarioRetirada');
                select.innerHTML = '<option value="">Selecione o usu√°rio...</option>';
                
                usuariosDisponiveis.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.email;
                    option.text = usuario.email;
                    select.add(option);
                });
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }
        
        async function carregarPixPrincipal() {
            try {
                pixPrincipal = await FirebaseDatabase.obterPixPrincipal();
                const chavePix = pixPrincipal ? pixPrincipal.chave : 'PIX n√£o cadastrado';
                
                // Atualizar elementos da p√°gina
                const elementoChavePix = document.getElementById('chavePix');
                const elementoChavePixEntrada = document.getElementById('chavePixEntrada');
                
                if (elementoChavePix) {
                    elementoChavePix.textContent = chavePix;
                }
                if (elementoChavePixEntrada) {
                    elementoChavePixEntrada.textContent = chavePix;
                }
                
                console.log('PIX carregado:', chavePix);
                
            } catch (error) {
                console.error('Erro ao carregar PIX:', error);
            }
        }
        
        async function carregarMaquinas() {
            try {
                maquinasDisponiveis = await FirebaseDatabase.obterMaquinas();
                
                const selects = ['maquinaCartao', 'maquinaCartaoEntrada'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Selecione...</option>';
                        maquinasDisponiveis.forEach(maquina => {
                            const option = document.createElement('option');
                            option.value = maquina.codigo;
                            option.text = maquina.nome;
                            select.add(option);
                        });
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar m√°quinas:', error);
            }
        }
        
        function alterarTipoOperacao() {
            const radios = document.getElementsByName('tipoOperacao');
            tipoOperacao = Array.from(radios).find(r => r.checked).value;
            
            const dadosCliente = document.getElementById('dadosCliente');
            const seletorUsuario = document.getElementById('seletorUsuario');
            const tituloCliente = document.getElementById('tituloCliente');
            const btnFinalizar = document.getElementById('btnFinalizar');
            
            if (tipoOperacao === 'retirada') {
                dadosCliente.style.display = 'none';
                seletorUsuario.style.display = 'block';
                tituloCliente.textContent = 'Usu√°rio da Retirada';
                btnFinalizar.textContent = 'Finalizar Retirada';
                
                // Esconder op√ß√µes de pagamento
                const formaPagamento = document.getElementById('formaPagamento').closest('.form-group');
                const temEntrada = document.getElementById('temEntrada').closest('.form-group');
                const descontoGroup = document.getElementById('descontoGroup');
                
                if (formaPagamento) formaPagamento.style.display = 'none';
                if (temEntrada) temEntrada.style.display = 'none';
                if (descontoGroup) descontoGroup.style.display = 'none';
            } else {
                dadosCliente.style.display = 'block';
                seletorUsuario.style.display = 'none';
                tituloCliente.textContent = 'Dados do Cliente';
                btnFinalizar.textContent = 'Finalizar Venda';
                
                // Mostrar op√ß√µes de pagamento
                const formaPagamento = document.getElementById('formaPagamento').closest('.form-group');
                const temEntrada = document.getElementById('temEntrada').closest('.form-group');
                
                if (formaPagamento) formaPagamento.style.display = 'block';
                if (temEntrada) temEntrada.style.display = 'block';
                // Desconto ser√° mostrado apenas se for √† vista
            }
            
            limparCarrinho();
        }

        function buscarPecas() {
            const termo = document.getElementById('buscaPeca').value.toLowerCase();
            const select = document.getElementById('selectPeca');
            
            // Limpar select
            select.innerHTML = '<option value="">Selecione uma pe√ßa...</option>';
            
            if (!termo) {
                // Se n√£o h√° termo, mostrar todas as pe√ßas
                produtosDisponiveis.forEach(produto => {
                    const option = document.createElement('option');
                    option.value = produto.id;
                    option.text = `${produto.nome} - ${produto.marca} (${produto.codigo})`;
                    select.add(option);
                });
                return;
            }
            
            // Filtrar pe√ßas pelo termo
            const produtosFiltrados = produtosDisponiveis.filter(produto => 
                produto.nome.toLowerCase().includes(termo) || 
                produto.codigo.toLowerCase().includes(termo) ||
                produto.marca.toLowerCase().includes(termo)
            );
            
            produtosFiltrados.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.text = `${produto.nome} - ${produto.marca} (${produto.codigo})`;
                select.add(option);
            });
        }

        function mostrarDetalhesPeca() {
            const selectPeca = document.getElementById('selectPeca');
            const detalhesPeca = document.getElementById('detalhesPeca');
            const infoPeca = document.getElementById('infoPeca');
            const quantidadeInput = document.getElementById('quantidade');
            
            if (!selectPeca.value) {
                detalhesPeca.style.display = 'none';
                pecaSelecionada = null;
                return;
            }
            
            pecaSelecionada = produtosDisponiveis.find(p => p.id === selectPeca.value);
            
            if (pecaSelecionada) {
                infoPeca.innerHTML = `
                    <strong>${pecaSelecionada.nome}</strong><br>
                    <strong>C√≥digo:</strong> ${pecaSelecionada.codigo}<br>
                    <strong>Marca:</strong> ${pecaSelecionada.marca}<br>
                    <strong>Cor:</strong> ${pecaSelecionada.cor}<br>
                    <strong>Tamanho:</strong> ${pecaSelecionada.tamanho}<br>
                    <strong>Pre√ßo:</strong> R$ ${pecaSelecionada.preco.toFixed(2)}<br>
                    <strong>Estoque:</strong> ${pecaSelecionada.estoque} unidades
                `;
                
                quantidadeInput.max = pecaSelecionada.estoque;
                quantidadeInput.value = 1;
                detalhesPeca.style.display = 'block';
            }
        }

        function adicionarAoCarrinho() {
            if (!pecaSelecionada) {
                alert('Selecione uma pe√ßa primeiro!');
                return;
            }
            
            const quantidade = parseInt(document.getElementById('quantidade').value);
            
            if (quantidade <= 0 || quantidade > pecaSelecionada.estoque) {
                alert('Quantidade inv√°lida!');
                return;
            }
            
            // Verificar se j√° est√° no carrinho
            const itemExistente = carrinho.find(item => item.id === pecaSelecionada.id);
            
            if (itemExistente) {
                const novaQuantidade = itemExistente.quantidade + quantidade;
                if (novaQuantidade <= pecaSelecionada.estoque) {
                    itemExistente.quantidade = novaQuantidade;
                } else {
                    alert('Quantidade total excede o estoque dispon√≠vel!');
                    return;
                }
            } else {
                carrinho.push({
                    ...pecaSelecionada,
                    quantidade: quantidade
                });
            }
            
            // Limpar sele√ß√£o
            document.getElementById('selectPeca').value = '';
            document.getElementById('detalhesPeca').style.display = 'none';
            pecaSelecionada = null;
            
            atualizarCarrinho();
        }

        function removerDoCarrinho(produtoId) {
            carrinho = carrinho.filter(item => item.id !== produtoId);
            atualizarCarrinho();
        }

        function alterarQuantidade(produtoId, novaQuantidade) {
            const item = carrinho.find(item => item.id === produtoId);
            const produto = produtosDisponiveis.find(p => p.id === produtoId);
            
            if (novaQuantidade <= 0) {
                removerDoCarrinho(produtoId);
                return;
            }
            
            if (novaQuantidade > produto.estoque) {
                alert('Quantidade maior que o estoque dispon√≠vel!');
                return;
            }
            
            item.quantidade = novaQuantidade;
            atualizarCarrinho();
        }

        function atualizarCarrinho() {
            const container = document.getElementById('itensCarrinho');
            const btnFinalizar = document.getElementById('btnFinalizar');

            if (carrinho.length === 0) {
                container.innerHTML = '<p>Carrinho vazio</p>';
                btnFinalizar.disabled = true;
                calcularTotal();
                return;
            }

            container.innerHTML = carrinho.map(item => `
                <div class="carrinho-item">
                    <div>
                        <strong>${item.nome}</strong><br>
                        <small>R$ ${item.preco.toFixed(2)} cada</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" value="${item.quantidade}" min="1" max="${item.estoque}" 
                               onchange="alterarQuantidade('${item.id}', parseInt(this.value))" 
                               style="width: 60px;">
                        <button class="btn btn-secondary" onclick="removerDoCarrinho('${item.id}')" style="padding: 0.3rem;">√ó</button>
                    </div>
                </div>
            `).join('');

            // Validar se pode finalizar
            if (tipoOperacao === 'retirada') {
                const usuarioSelecionado = document.getElementById('usuarioRetirada').value;
                btnFinalizar.disabled = !usuarioSelecionado;
            } else {
                btnFinalizar.disabled = false;
            }
            
            calcularTotal();
        }
        
        function atualizarOpcoesParcelamento(saldoRestante) {
            const selectCredito = document.getElementById('parcelas');
            const selectCrediario = document.getElementById('parcelasCrediario');
            
            // Salvar valor selecionado atual
            const valorAtualCredito = selectCredito.value;
            const valorAtualCrediario = selectCrediario.value;
            
            // Limpar op√ß√µes
            selectCredito.innerHTML = '<option value="1">1x</option>';
            selectCrediario.innerHTML = '<option value="1">1x</option>';
            
            // Calcular m√°ximo de parcelas baseado no valor (m√≠nimo R$ 100 por parcela)
            let maxParcelas = 1;
            if (saldoRestante >= 200) maxParcelas = 2;
            if (saldoRestante >= 300) maxParcelas = 3;
            if (saldoRestante >= 400) maxParcelas = 4;
            
            // Adicionar op√ß√µes de parcelamento
            for (let i = 2; i <= maxParcelas; i++) {
                const valorParcela = saldoRestante / i;
                
                // Cr√©dito
                const optionCredito = document.createElement('option');
                optionCredito.value = i;
                optionCredito.text = `${i}x de R$ ${valorParcela.toFixed(2)}`;
                selectCredito.add(optionCredito);
                
                // Credi√°rio
                const optionCrediario = document.createElement('option');
                optionCrediario.value = i;
                optionCrediario.text = `${i}x de R$ ${valorParcela.toFixed(2)}`;
                selectCrediario.add(optionCrediario);
            }
            
            // Restaurar valor selecionado se ainda v√°lido
            if (valorAtualCredito && valorAtualCredito <= maxParcelas) {
                selectCredito.value = valorAtualCredito;
            }
            if (valorAtualCrediario && valorAtualCrediario <= maxParcelas) {
                selectCrediario.value = valorAtualCrediario;
            }
        }
        
        function mostrarOpcoesPagamento() {
            const formaPagamento = document.getElementById('formaPagamento').value;
            const dataPromessaGroup = document.getElementById('dataPromessaGroup');
            const descontoGroup = document.getElementById('descontoGroup');
            
            // Esconder todas as op√ß√µes
            document.getElementById('opcoesCreditoDebito').style.display = 'none';
            document.getElementById('opcoesBandeira').style.display = 'none';
            document.getElementById('opcoesCredito').style.display = 'none';
            document.getElementById('opcoesAvista').style.display = 'none';
            document.getElementById('opcoesCrediario').style.display = 'none';
            document.getElementById('infoTaxa').style.display = 'none';
            
            // Limpar sele√ß√µes
            document.getElementById('maquinaCartao').value = '';
            document.getElementById('bandeiraCartao').value = '';
            
            // Mostrar/esconder desconto baseado na forma de pagamento
            if (formaPagamento === 'avista') {
                descontoGroup.style.display = 'block';
            } else {
                descontoGroup.style.display = 'none';
                document.getElementById('desconto').value = '0';
            }
            
            // Mostrar/esconder data promessa
            if (formaPagamento === 'credito' || formaPagamento === 'crediario') {
                dataPromessaGroup.style.display = 'block';
            } else {
                dataPromessaGroup.style.display = 'none';
                document.getElementById('dataPromessa').value = '';
            }
            
            // Mostrar op√ß√µes espec√≠ficas
            if (formaPagamento === 'credito') {
                document.getElementById('opcoesCreditoDebito').style.display = 'block';
                document.getElementById('opcoesCredito').style.display = 'block';
            } else if (formaPagamento === 'debito') {
                document.getElementById('opcoesCreditoDebito').style.display = 'block';
            } else if (formaPagamento === 'avista') {
                document.getElementById('opcoesAvista').style.display = 'block';
            } else if (formaPagamento === 'crediario') {
                document.getElementById('opcoesCrediario').style.display = 'block';
            }
            
            calcularTotal();
        }
        
        function mostrarBandeiras() {
            const maquinaSelecionada = document.getElementById('maquinaCartao').value;
            const opcoesBandeira = document.getElementById('opcoesBandeira');
            
            if (maquinaSelecionada) {
                opcoesBandeira.style.display = 'block';
            } else {
                opcoesBandeira.style.display = 'none';
                document.getElementById('bandeiraCartao').value = '';
            }
            
            // Esconder parcelamento at√© selecionar bandeira
            document.getElementById('opcoesCredito').style.display = 'none';
            calcularTotal();
        }
        
        function mostrarParcelamento() {
            const formaPagamento = document.getElementById('formaPagamento').value;
            const bandeiraSelecionada = document.getElementById('bandeiraCartao').value;
            
            if (formaPagamento === 'credito' && bandeiraSelecionada) {
                document.getElementById('opcoesCredito').style.display = 'block';
            } else {
                document.getElementById('opcoesCredito').style.display = 'none';
            }
            
            calcularTotal();
        }
        
        function mostrarBandeirasEntrada() {
            const maquinaSelecionada = document.getElementById('maquinaCartaoEntrada').value;
            const opcoesBandeiraEntrada = document.getElementById('opcoesBandeiraEntrada');
            
            if (maquinaSelecionada) {
                opcoesBandeiraEntrada.style.display = 'block';
            } else {
                opcoesBandeiraEntrada.style.display = 'none';
                document.getElementById('bandeiraCartaoEntrada').value = '';
            }
            
            calcularTotal();
        }
        
        function mostrarOpcoesPix() {
            const tipoAvista = document.getElementById('tipoAvista').value;
            const opcoesPix = document.getElementById('opcoesPix');
            
            if (tipoAvista === 'pix') {
                opcoesPix.style.display = 'block';
            } else {
                opcoesPix.style.display = 'none';
                document.getElementById('qrCodeContainer').style.display = 'none';
            }
        }
        
        function mostrarOpcoesEntrada() {
            const temEntrada = document.getElementById('temEntrada').checked;
            const opcoesEntrada = document.getElementById('opcoesEntrada');
            
            if (temEntrada) {
                opcoesEntrada.style.display = 'block';
            } else {
                opcoesEntrada.style.display = 'none';
                document.getElementById('valorEntrada').value = '';
                document.getElementById('formaPagamentoEntrada').value = '';
                document.getElementById('opcoesDebitoEntrada').style.display = 'none';
                document.getElementById('opcoesBandeiraEntrada').style.display = 'none';
                document.getElementById('opcoesAvistaEntrada').style.display = 'none';
            }
            
            const formaPagamentoEntrada = document.getElementById('formaPagamentoEntrada').value;
            
            // Esconder op√ß√µes da entrada
            document.getElementById('opcoesDebitoEntrada').style.display = 'none';
            document.getElementById('opcoesBandeiraEntrada').style.display = 'none';
            document.getElementById('opcoesAvistaEntrada').style.display = 'none';
            
            // Limpar sele√ß√µes da entrada
            document.getElementById('maquinaCartaoEntrada').value = '';
            document.getElementById('bandeiraCartaoEntrada').value = '';
            
            // Mostrar op√ß√µes espec√≠ficas da entrada
            if (formaPagamentoEntrada === 'debito') {
                document.getElementById('opcoesDebitoEntrada').style.display = 'block';
            } else if (formaPagamentoEntrada === 'avista') {
                document.getElementById('opcoesAvistaEntrada').style.display = 'block';
            }
            
            calcularTotal();
        }
        
        function mostrarOpcoesPixEntrada() {
            const tipoAvistaEntrada = document.getElementById('tipoAvistaEntrada').value;
            const opcoesPixEntrada = document.getElementById('opcoesPixEntrada');
            
            if (tipoAvistaEntrada === 'pix') {
                opcoesPixEntrada.style.display = 'block';
            } else {
                opcoesPixEntrada.style.display = 'none';
                document.getElementById('qrCodeContainerEntrada').style.display = 'none';
            }
        }
        
        function copiarChavePix() {
            const chavePix = pixPrincipal ? pixPrincipal.chave : 'PIX n√£o cadastrado';
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(chavePix).then(() => {
                        alert('Chave PIX copiada!');
                    }).catch(() => {
                        copiarTextoFallback(chavePix);
                    });
                } else {
                    copiarTextoFallback(chavePix);
                }
            } catch (error) {
                copiarTextoFallback(chavePix);
            }
        }
        
        function copiarChavePixEntrada() {
            const chavePix = pixPrincipal ? pixPrincipal.chave : 'PIX n√£o cadastrado';
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(chavePix).then(() => {
                        alert('Chave PIX copiada!');
                    }).catch(() => {
                        copiarTextoFallback(chavePix);
                    });
                } else {
                    copiarTextoFallback(chavePix);
                }
            } catch (error) {
                copiarTextoFallback(chavePix);
            }
        }
        
        function copiarTextoFallback(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Chave PIX copiada!');
        }
        
        function calcularTotalVenda() {
            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const temEntrada = document.getElementById('temEntrada').checked;
            const valorEntrada = temEntrada ? parseFloat(document.getElementById('valorEntrada').value) || 0 : 0;
            return Math.max(0, subtotal - desconto - valorEntrada);
        }

        function calcularTotal() {
            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const total = Math.max(0, subtotal - desconto);
            const temEntrada = document.getElementById('temEntrada').checked;
            const valorEntrada = temEntrada ? parseFloat(document.getElementById('valorEntrada').value) || 0 : 0;
            const saldoRestante = Math.max(0, total - valorEntrada);
            
            // Atualizar op√ß√µes de parcelamento baseado no saldo restante
            atualizarOpcoesParcelamento(saldoRestante);
            
            // Calcular taxa da m√°quina se aplic√°vel
            const formaPagamento = document.getElementById('formaPagamento').value;
            let infoTaxa = '';
            let valorLiquido = total;
            
            if ((formaPagamento === 'credito' || formaPagamento === 'debito') && 
                document.getElementById('maquinaCartao').value && 
                document.getElementById('bandeiraCartao').value) {
                
                const codigoMaquina = document.getElementById('maquinaCartao').value;
                const bandeira = document.getElementById('bandeiraCartao').value;
                const maquina = maquinasDisponiveis.find(m => m.codigo === codigoMaquina);
                
                if (maquina && maquina.bandeiras && maquina.bandeiras[bandeira]) {
                    let taxa = 0;
                    
                    if (formaPagamento === 'debito') {
                        taxa = maquina.bandeiras[bandeira].debito || 0;
                    } else if (formaPagamento === 'credito') {
                        const parcelas = document.getElementById('parcelas').value || '1';
                        taxa = maquina.bandeiras[bandeira][`${parcelas}x`] || maquina.bandeiras[bandeira]['1x'] || 0;
                    }
                    
                    const valorTaxa = saldoRestante * (taxa / 100);
                    valorLiquido = saldoRestante - valorTaxa;
                    
                    infoTaxa = `Taxa ${taxa}% (${bandeira.toUpperCase()}) sobre saldo: R$ ${valorTaxa.toFixed(2)} | L√≠quido: R$ ${valorLiquido.toFixed(2)}`;
                    document.getElementById('infoTaxa').textContent = infoTaxa;
                    document.getElementById('infoTaxa').style.display = 'block';
                } else {
                    document.getElementById('infoTaxa').style.display = 'none';
                }
            } else {
                document.getElementById('infoTaxa').style.display = 'none';
            }
            
            document.getElementById('subtotal').textContent = `Subtotal: R$ ${subtotal.toFixed(2)}`;
            document.getElementById('valorDesconto').textContent = `Desconto: R$ ${desconto.toFixed(2)}`;
            document.getElementById('totalVenda').textContent = `Total: R$ ${total.toFixed(2)}`;
            
            // Mostrar/esconder informa√ß√µes da entrada
            if (temEntrada && valorEntrada > 0) {
                document.getElementById('valorEntradaDisplay').style.display = 'block';
                document.getElementById('valorEntradaDisplay').textContent = `Entrada: R$ ${valorEntrada.toFixed(2)}`;
                document.getElementById('saldoRestante').style.display = 'block';
                document.getElementById('saldoRestante').textContent = `Saldo Restante: R$ ${saldoRestante.toFixed(2)}`;
            } else {
                document.getElementById('valorEntradaDisplay').style.display = 'none';
                document.getElementById('saldoRestante').style.display = 'none';
            }
            
            // Mostrar informa√ß√µes de parcelamento e cronograma
            const parcelamentoInfo = document.getElementById('parcelamentoInfo');
            const cronogramaPagamentos = document.getElementById('cronogramaPagamentos');
            const dataPromessa = document.getElementById('dataPromessa').value;
            
            if (formaPagamento === 'credito') {
                const parcelas = document.getElementById('parcelas').value;
                if (parcelas && parcelas > 1) {
                    const valorParcela = saldoRestante / parcelas;
                    parcelamentoInfo.style.display = 'block';
                    parcelamentoInfo.textContent = `Parcelado em ${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
                    
                    // Mostrar cronograma se data informada
                    if (dataPromessa) {
                        mostrarCronograma(dataPromessa, parcelas, valorParcela);
                    } else {
                        cronogramaPagamentos.style.display = 'none';
                    }
                } else {
                    parcelamentoInfo.style.display = 'none';
                    cronogramaPagamentos.style.display = 'none';
                }
            } else if (formaPagamento === 'crediario') {
                const parcelas = document.getElementById('parcelasCrediario').value;
                if (parcelas && parcelas > 1) {
                    const valorParcela = saldoRestante / parcelas;
                    parcelamentoInfo.style.display = 'block';
                    parcelamentoInfo.textContent = `Credi√°rio em ${parcelas}x de R$ ${valorParcela.toFixed(2)}`;
                    
                    // Mostrar cronograma se data informada
                    if (dataPromessa) {
                        mostrarCronograma(dataPromessa, parcelas, valorParcela);
                    } else {
                        cronogramaPagamentos.style.display = 'none';
                    }
                } else {
                    parcelamentoInfo.style.display = 'none';
                    cronogramaPagamentos.style.display = 'none';
                }
            } else {
                parcelamentoInfo.style.display = 'none';
                cronogramaPagamentos.style.display = 'none';
            }
        }

        function limparCarrinho() {
            carrinho = [];
            document.getElementById('nomeCliente').value = '';
            document.getElementById('emailCliente').value = '';
            document.getElementById('telefoneCliente').value = '';
            document.getElementById('cpfCliente').value = '';
            document.getElementById('desconto').value = 0;
            document.getElementById('formaPagamento').value = '';
            document.getElementById('temEntrada').checked = false;
            document.getElementById('valorEntrada').value = '';
            document.getElementById('dataPromessa').value = '';
            document.getElementById('parcelamentoInfo').style.display = 'none';
            document.getElementById('cronogramaPagamentos').style.display = 'none';
            document.getElementById('dataPromessaGroup').style.display = 'none';
            document.getElementById('formaPagamentoEntrada').value = '';
            document.getElementById('qrCodeContainer').style.display = 'none';
            document.getElementById('qrCodeContainerEntrada').style.display = 'none';
            // Esconder mensagens de erro
            document.getElementById('nomeError').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            document.getElementById('telefoneError').style.display = 'none';
            document.getElementById('cpfError').style.display = 'none';
            mostrarOpcoesPagamento(); // Reset op√ß√µes
            mostrarOpcoesEntrada(); // Reset entrada
            atualizarCarrinho();
        }

        async function finalizarOperacao() {
            if (carrinho.length === 0) {
                alert('Adicione pelo menos uma pe√ßa ao carrinho!');
                return;
            }
            
            if (tipoOperacao === 'retirada') {
                return finalizarRetirada();
            } else {
                return finalizarVenda();
            }
        }
        
        async function finalizarRetirada() {
            const usuarioRetirada = document.getElementById('usuarioRetirada').value;
            
            if (!usuarioRetirada) {
                alert('Selecione o usu√°rio que fez a retirada!');
                return;
            }
            
            if (!confirm('Confirma a retirada interna?')) return;
            
            try {
                const retirada = {
                    tipo: 'retirada_interna',
                    cliente: {
                        nome: `Retirada Interna - ${usuarioRetirada}`,
                        email: usuarioRetirada,
                        telefone: '',
                        cpf: '000.000.000-00'
                    },
                    itens: carrinho.map(item => ({
                        produtoId: item.id,
                        codigo: item.codigo,
                        nome: item.nome,
                        preco: item.preco,
                        quantidade: item.quantidade,
                        subtotal: item.preco * item.quantidade
                    })),
                    subtotal: carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0),
                    desconto: 0,
                    total: carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0),
                    pagamento: { formaPagamento: 'retirada_interna' },
                    dataVenda: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Atualizar estoque
                for (const item of carrinho) {
                    const produto = produtosDisponiveis.find(p => p.id === item.id);
                    const novoEstoque = produto.estoque - item.quantidade;
                    await FirebaseDatabase.atualizarEstoque(item.id, novoEstoque);
                }
                
                // Salvar como venda
                await FirebaseDatabase.registrarRetirada(retirada);
                
                alert('Retirada interna registrada com sucesso!');
                limparCarrinho();
                carregarProdutos();
                
            } catch (error) {
                console.error('Erro ao registrar retirada:', error);
                alert('Erro ao registrar retirada.');
            }
        }
        
        async function finalizarVenda() {
            
            // Validar dados do cliente
            if (!validarDadosCliente()) {
                alert('Por favor, corrija os dados do cliente antes de finalizar a venda.');
                return;
            }
            
            const formaPagamento = document.getElementById('formaPagamento').value;
            if (!formaPagamento) {
                alert('Selecione a forma de pagamento!');
                return;
            }
            
            // Valida√ß√µes espec√≠ficas
            if (formaPagamento === 'credito' || formaPagamento === 'debito') {
                const maquina = document.getElementById('maquinaCartao').value;
                const bandeira = document.getElementById('bandeiraCartao').value;
                
                if (!maquina) {
                    alert('Selecione a m√°quina de cart√£o!');
                    return;
                }
                
                if (!bandeira) {
                    alert('Selecione a bandeira do cart√£o!');
                    return;
                }
            } else if (formaPagamento === 'avista') {
                const tipoAvista = document.getElementById('tipoAvista').value;
                if (!tipoAvista) {
                    alert('Selecione o tipo de pagamento √† vista!');
                    return;
                }
            }
            
            const temEntrada = document.getElementById('temEntrada').checked;
            if (temEntrada) {
                const valorEntrada = parseFloat(document.getElementById('valorEntrada').value) || 0;
                const formaPagamentoEntrada = document.getElementById('formaPagamentoEntrada').value;
                
                if (valorEntrada <= 0) {
                    alert('Digite o valor da entrada!');
                    return;
                }
                
                if (!formaPagamentoEntrada) {
                    alert('Selecione a forma de pagamento da entrada!');
                    return;
                }
                
                if (formaPagamentoEntrada === 'debito') {
                    const maquinaEntrada = document.getElementById('maquinaCartaoEntrada').value;
                    const bandeiraEntrada = document.getElementById('bandeiraCartaoEntrada').value;
                    
                    if (!maquinaEntrada) {
                        alert('Selecione a m√°quina de cart√£o da entrada!');
                        return;
                    }
                    
                    if (!bandeiraEntrada) {
                        alert('Selecione a bandeira do cart√£o da entrada!');
                        return;
                    }
                } else if (formaPagamentoEntrada === 'avista') {
                    const tipoAvistaEntrada = document.getElementById('tipoAvistaEntrada').value;
                    if (!tipoAvistaEntrada) {
                        alert('Selecione o tipo de pagamento √† vista da entrada!');
                        return;
                    }
                }
            }

            if (!confirm('Confirma a finaliza√ß√£o da venda?')) return;

            try {
                const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                const desconto = parseFloat(document.getElementById('desconto').value) || 0;
                const total = Math.max(0, subtotal - desconto);
                const temEntrada = document.getElementById('temEntrada').checked;
                const valorEntrada = temEntrada ? parseFloat(document.getElementById('valorEntrada').value) || 0 : 0;
                const saldoRestante = Math.max(0, total - valorEntrada);
                
                // Dados espec√≠ficos do pagamento
                const dadosPagamento = {
                    formaPagamento: formaPagamento
                };
                
                // Dados da entrada (se houver)
                let dadosEntrada = null;
                if (temEntrada && valorEntrada > 0) {
                    const formaPagamentoEntrada = document.getElementById('formaPagamentoEntrada').value;
                    dadosEntrada = {
                        valor: valorEntrada,
                        formaPagamento: formaPagamentoEntrada
                    };
                    
                    if (formaPagamentoEntrada === 'debito') {
                        dadosEntrada.maquina = document.getElementById('maquinaCartaoEntrada').value;
                        dadosEntrada.bandeira = document.getElementById('bandeiraCartaoEntrada').value;
                    } else if (formaPagamentoEntrada === 'avista') {
                        dadosEntrada.tipo = document.getElementById('tipoAvistaEntrada').value;
                    }
                }
                
                if (formaPagamento === 'credito') {
                    dadosPagamento.maquina = document.getElementById('maquinaCartao').value;
                    dadosPagamento.bandeira = document.getElementById('bandeiraCartao').value;
                    dadosPagamento.parcelas = document.getElementById('parcelas').value;
                } else if (formaPagamento === 'debito') {
                    dadosPagamento.maquina = document.getElementById('maquinaCartao').value;
                    dadosPagamento.bandeira = document.getElementById('bandeiraCartao').value;
                } else if (formaPagamento === 'avista') {
                    dadosPagamento.tipo = document.getElementById('tipoAvista').value;
                } else if (formaPagamento === 'crediario') {
                    dadosPagamento.parcelas = document.getElementById('parcelasCrediario').value;
                }
                
                // Atualizar estoque apenas se n√£o for edi√ß√£o
                if (!vendaEditandoId) {
                    // Nova venda - diminuir estoque
                    for (const item of carrinho) {
                        const novoEstoque = item.estoque - item.quantidade;
                        await FirebaseDatabase.atualizarEstoque(item.id, novoEstoque);
                    }
                } else {
                    // Edi√ß√£o - ajustar estoque baseado na diferen√ßa
                    for (const item of carrinho) {
                        const itemOriginal = vendaOriginal.itens.find(i => i.produtoId === item.id);
                        const quantidadeOriginal = itemOriginal ? itemOriginal.quantidade : 0;
                        const diferenca = item.quantidade - quantidadeOriginal;
                        
                        if (diferenca !== 0) {
                            const novoEstoque = item.estoque - diferenca;
                            await FirebaseDatabase.atualizarEstoque(item.id, novoEstoque);
                        }
                    }
                    
                    // Restaurar estoque de itens removidos
                    for (const itemOriginal of vendaOriginal.itens) {
                        const itemAtual = carrinho.find(i => i.id === itemOriginal.produtoId);
                        if (!itemAtual) {
                            // Item foi removido, restaurar estoque
                            const produto = produtosDisponiveis.find(p => p.id === itemOriginal.produtoId);
                            if (produto) {
                                const novoEstoque = produto.estoque + itemOriginal.quantidade;
                                await FirebaseDatabase.atualizarEstoque(itemOriginal.produtoId, novoEstoque);
                            }
                        }
                    }
                }

                // Dados do cliente
                const cliente = {
                    nome: document.getElementById('nomeCliente').value,
                    email: document.getElementById('emailCliente').value || '',
                    telefone: document.getElementById('telefoneCliente').value,
                    cpf: document.getElementById('cpfCliente').value
                };
                
                // Registrar ou atualizar venda
                const venda = {
                    cliente: cliente,
                    itens: carrinho.map(item => ({
                        produtoId: item.id,
                        nome: item.nome,
                        codigo: item.codigo,
                        preco: item.preco,
                        quantidade: item.quantidade,
                        subtotal: item.preco * item.quantidade
                    })),
                    subtotal: subtotal,
                    desconto: desconto,
                    total: total,
                    entrada: dadosEntrada,
                    saldoRestante: saldoRestante,
                    pagamento: dadosPagamento,
                    dataPromessa: document.getElementById('dataPromessa').value || null
                };

                // Obter usu√°rio atual para hist√≥rico
                const user = firebase.auth().currentUser;
                const usuarioEmail = user ? user.email : 'Usu√°rio desconhecido';

                if (vendaEditandoId) {
                    // Atualizar venda existente
                    await FirebaseDatabase.atualizarVenda(vendaEditandoId, venda);
                    
                    // Registrar no hist√≥rico
                    await FirebaseDatabase.registrarHistorico(
                        'ATUALIZACAO_VENDA',
                        {
                            vendaId: vendaEditandoId,
                            cliente: cliente.nome,
                            total: total,
                            formaPagamento: formaPagamento
                        },
                        usuarioEmail
                    );
                    
                    alert(`Venda atualizada com sucesso!\nTotal: R$ ${total.toFixed(2)}`);
                } else {
                    // Nova venda
                    venda.dataVenda = firebase.firestore.FieldValue.serverTimestamp();
                    const vendaId = await FirebaseDatabase.registrarVenda(venda);
                    
                    // Registrar no hist√≥rico
                    await FirebaseDatabase.registrarHistorico(
                        'NOVA_VENDA',
                        {
                            vendaId: vendaId,
                            cliente: cliente.nome,
                            total: total,
                            formaPagamento: formaPagamento,
                            itens: carrinho.map(item => `${item.quantidade}x ${item.nome}`)
                        },
                        usuarioEmail
                    );
                    
                    alert(`Venda finalizada com sucesso!\nTotal: R$ ${total.toFixed(2)}\nForma de pagamento: ${getFormaPagamentoTexto(formaPagamento)}`);
                }

                // Limpar vari√°veis de edi√ß√£o
                vendaEditandoId = null;
                vendaOriginal = null;
                document.getElementById('btnFinalizar').textContent = 'Finalizar Venda';
                
                limparCarrinho();
                carregarProdutos(); // Recarregar para atualizar estoques

            } catch (error) {
                alert('Erro ao finalizar venda.');
                console.error('Erro:', error);
            }
        }
        
        function mostrarCronograma(dataInicial, parcelas, valorParcela) {
            const cronograma = document.getElementById('cronogramaPagamentos');
            let html = '<strong>Cronograma de Pagamentos:</strong><br>';
            
            const data = new Date(dataInicial + 'T00:00:00');
            
            for (let i = 1; i <= parcelas; i++) {
                const dataParcela = new Date(data);
                dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
                
                const dia = dataParcela.getDate().toString().padStart(2, '0');
                const mes = (dataParcela.getMonth() + 1).toString().padStart(2, '0');
                const ano = dataParcela.getFullYear();
                
                html += `${i}¬™ parcela: ${dia}/${mes}/${ano} - R$ ${valorParcela.toFixed(2)}<br>`;
            }
            
            cronograma.innerHTML = html;
            cronograma.style.display = 'block';
        }
        
        let vendaEditandoId = null;
        let vendaOriginal = null;

        async function carregarVendaParaEdicao(vendaId) {
            try {
                const venda = await FirebaseDatabase.obterVendaPorId(vendaId);
                if (!venda) {
                    alert('Venda n√£o encontrada!');
                    return;
                }

                // Salvar refer√™ncia da venda sendo editada
                vendaEditandoId = vendaId;
                vendaOriginal = venda;

                // Carregar dados do cliente
                if (venda.cliente) {
                    document.getElementById('nomeCliente').value = venda.cliente.nome || '';
                    document.getElementById('emailCliente').value = venda.cliente.email || '';
                    document.getElementById('telefoneCliente').value = venda.cliente.telefone || '';
                    document.getElementById('cpfCliente').value = venda.cliente.cpf || '';
                }

                // Carregar itens no carrinho
                carrinho = [];
                for (const item of venda.itens) {
                    // Encontrar produto nos dispon√≠veis
                    const produto = produtosDisponiveis.find(p => p.id === item.produtoId);
                    if (produto) {
                        carrinho.push({
                            ...produto,
                            quantidade: item.quantidade
                        });
                    }
                }
                atualizarCarrinho();

                // Carregar desconto
                if (venda.desconto) {
                    document.getElementById('desconto').value = venda.desconto;
                }

                // Carregar entrada
                if (venda.entrada) {
                    document.getElementById('temEntrada').checked = true;
                    document.getElementById('valorEntrada').value = venda.entrada.valor;
                    document.getElementById('formaPagamentoEntrada').value = venda.entrada.formaPagamento;
                    mostrarOpcoesEntrada();
                }

                // Carregar forma de pagamento
                if (venda.pagamento) {
                    document.getElementById('formaPagamento').value = venda.pagamento.formaPagamento;
                    mostrarOpcoesPagamento();
                    
                    if (venda.pagamento.parcelas) {
                        if (venda.pagamento.formaPagamento === 'credito') {
                            document.getElementById('parcelas').value = venda.pagamento.parcelas;
                        } else if (venda.pagamento.formaPagamento === 'crediario') {
                            document.getElementById('parcelasCrediario').value = venda.pagamento.parcelas;
                        }
                    }
                }

                // Carregar data promessa
                if (venda.dataPromessa) {
                    document.getElementById('dataPromessa').value = venda.dataPromessa;
                }

                calcularTotal();
                
                // Alterar texto do bot√£o
                document.getElementById('btnFinalizar').textContent = 'Atualizar Venda';
                alert('Venda carregada para edi√ß√£o!');
                
            } catch (error) {
                console.error('Erro ao carregar venda para edi√ß√£o:', error);
                alert('Erro ao carregar venda.');
            }
        }

        // Fun√ß√µes de valida√ß√£o
        function validarNome(nome) {
            const nomes = nome.trim().split(' ').filter(n => n.length > 0);
            return nomes.length >= 2;
        }

        function validarEmail(email) {
            if (!email) return true; // E-mail √© opcional
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validarTelefone(telefone) {
            const numeros = telefone.replace(/\D/g, '');
            return numeros.length === 11; // (00) 00000-0000
        }

        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf.charAt(10));
        }

        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{2})(\d)/, '($1) $2');
                valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
            }
            input.value = valor;
        }

        function aplicarMascaraCPF(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            input.value = valor;
        }

        function validarDadosCliente() {
            let valido = true;
            
            // Validar nome
            const nome = document.getElementById('nomeCliente').value;
            const nomeError = document.getElementById('nomeError');
            if (!validarNome(nome)) {
                nomeError.style.display = 'block';
                valido = false;
            } else {
                nomeError.style.display = 'none';
            }
            
            // Validar email
            const email = document.getElementById('emailCliente').value;
            const emailError = document.getElementById('emailError');
            if (!validarEmail(email)) {
                emailError.style.display = 'block';
                valido = false;
            } else {
                emailError.style.display = 'none';
            }
            
            // Validar telefone
            const telefone = document.getElementById('telefoneCliente').value;
            const telefoneError = document.getElementById('telefoneError');
            if (!validarTelefone(telefone)) {
                telefoneError.style.display = 'block';
                valido = false;
            } else {
                telefoneError.style.display = 'none';
            }
            
            // Validar CPF
            const cpf = document.getElementById('cpfCliente').value;
            const cpfError = document.getElementById('cpfError');
            if (!validarCPF(cpf)) {
                cpfError.style.display = 'block';
                valido = false;
            } else {
                cpfError.style.display = 'none';
            }
            
            return valido;
        }

        // Aplicar m√°scaras e valida√ß√µes em tempo real nos campos
        document.getElementById('nomeCliente').addEventListener('input', function() {
            const nome = this.value;
            const nomeError = document.getElementById('nomeError');
            if (nome && !validarNome(nome)) {
                nomeError.style.display = 'block';
            } else {
                nomeError.style.display = 'none';
            }
            
            // Buscar clientes por nome se tiver pelo menos 3 caracteres
            if (nome.length >= 3) {
                buscarClientesPorNome(nome);
            } else {
                document.getElementById('sugestoesClientes').style.display = 'none';
            }
        });

        document.getElementById('emailCliente').addEventListener('input', function() {
            const email = this.value;
            const emailError = document.getElementById('emailError');
            if (email && !validarEmail(email)) {
                emailError.style.display = 'block';
            } else {
                emailError.style.display = 'none';
            }
        });

        document.getElementById('telefoneCliente').addEventListener('input', function() {
            aplicarMascaraTelefone(this);
            const telefone = this.value;
            const telefoneError = document.getElementById('telefoneError');
            if (telefone && !validarTelefone(telefone)) {
                telefoneError.style.display = 'block';
            } else {
                telefoneError.style.display = 'none';
            }
        });

        document.getElementById('cpfCliente').addEventListener('input', function() {
            aplicarMascaraCPF(this);
            const cpf = this.value;
            const cpfError = document.getElementById('cpfError');
            if (cpf && !validarCPF(cpf)) {
                cpfError.style.display = 'block';
            } else {
                cpfError.style.display = 'none';
                // Se CPF v√°lido, buscar cliente existente
                if (cpf && validarCPF(cpf)) {
                    buscarClienteExistente(cpf);
                }
            }
        });

        function getFormaPagamentoTexto(forma) {
            const formas = {
                'credito': 'Cart√£o de Cr√©dito',
                'debito': 'Cart√£o de D√©bito',
                'avista': '√Ä Vista',
                'crediario': 'Credi√°rio'
            };
            return formas[forma] || forma;
        }

        async function buscarClienteExistente(cpf) {
            try {
                console.log('Buscando cliente por CPF:', cpf);
                const cliente = await FirebaseDatabase.buscarClientePorCPF(cpf);
                if (cliente) {
                    console.log('Cliente encontrado por CPF:', cliente.nome);
                    preencherDadosCliente(cliente);
                } else {
                    console.log('Nenhum cliente encontrado com CPF:', cpf);
                }
            } catch (error) {
                console.error('Erro ao buscar cliente:', error);
            }
        }

        async function buscarClientesPorNome(nomeInicial) {
            try {
                console.log('Buscando clientes por nome:', nomeInicial);
                const clientes = await FirebaseDatabase.buscarClientesPorNome(nomeInicial);
                console.log('Clientes encontrados:', clientes.length);
                mostrarSugestoesClientes(clientes);
            } catch (error) {
                console.error('Erro ao buscar clientes por nome:', error);
            }
        }

        function mostrarSugestoesClientes(clientes) {
            const sugestoes = document.getElementById('sugestoesClientes');
            
            if (clientes.length === 0) {
                sugestoes.style.display = 'none';
                return;
            }
            
            sugestoes.innerHTML = clientes.map(cliente => 
                `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" 
                      onclick="selecionarCliente('${cliente.cpf}')" 
                      onmouseover="this.style.backgroundColor='#f5f5f5'" 
                      onmouseout="this.style.backgroundColor='white'">
                    <strong>${cliente.nome}</strong><br>
                    <small>CPF: ${cliente.cpf} | Tel: ${cliente.telefone}</small>
                </div>`
            ).join('');
            
            sugestoes.style.display = 'block';
        }

        async function selecionarCliente(cpf) {
            const cliente = await FirebaseDatabase.buscarClientePorCPF(cpf);
            if (cliente) {
                preencherDadosCliente(cliente);
            }
            document.getElementById('sugestoesClientes').style.display = 'none';
        }

        function preencherDadosCliente(cliente) {
            document.getElementById('nomeCliente').value = cliente.nome || '';
            document.getElementById('emailCliente').value = cliente.email || '';
            document.getElementById('telefoneCliente').value = cliente.telefone || '';
            document.getElementById('cpfCliente').value = cliente.cpf || '';
            
            // Destacar que cliente foi encontrado
            const nomeField = document.getElementById('nomeCliente');
            nomeField.style.backgroundColor = '#e8f5e8';
            setTimeout(() => {
                nomeField.style.backgroundColor = '';
            }, 2000);
            
            console.log('Cliente encontrado e dados preenchidos:', cliente.nome);
        }

        // Esconder sugest√µes ao clicar fora
        document.addEventListener('click', function(event) {
            const sugestoes = document.getElementById('sugestoesClientes');
            const nomeInput = document.getElementById('nomeCliente');
            
            if (event.target !== nomeInput && !sugestoes.contains(event.target)) {
                sugestoes.style.display = 'none';
            }
        });
    </script>
</body>
</html>